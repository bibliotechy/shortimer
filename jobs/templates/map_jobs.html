{% extends "site.html" %}

{% block title %}Map of 25 most recent jobs with location data{% endblock %}

{% block extra_head %}
    <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.5/leaflet.css" />
    <!--[if lte IE 8]>
    <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.5/leaflet.ie.css" />
    <![endif]-->
    <style>
    #map {height:500px; width: 100%;}
    </style>


{% endblock extra_head %}

{% block content %}

    <div id="map-wrapper" class="span10 offset1">
        <div id="map" class="map"></div>
    </div>


{% endblock content %}

{% block extra_javascript %}
    <script src="http://cdn.leafletjs.com/leaflet-0.5/leaflet.js"></script>
    <script src="/static/js/maps.js"></script>
    <script src="http://leaflet.github.com/Leaflet.markercluster/dist/leaflet.markercluster-src.js"></script>
    <script>
        var map = L.map('map');
        L.tileLayer('http://{s}.tile.cloudmade.com/6b142f3144774208a33fff14cdc125e3/89852/256/{z}/{x}/{y}.png', {
            attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery Â© <a href="http://cloudmade.com">CloudMade</a>',
            maxZoom: 18
          }).addTo(map);

        //set up some placeholders
        var bounds = new L.LatLngBounds();
        var marker_count = 0;
        var oldest_job;
        var markers = new L.MarkerClusterGroup();
        //add a marker for each job, with a popup on click with Title and Employer
        {% for job in jobs %}


            marker = add_marker(
                    {
                        pk                  : {{job.pk}},
                        location__latitude  : {{ job.location.latitude }},
                        location__longitude : {{ job.location.longitude }},
                        title               : "{{ job.title }}",
                        employer__name      : "{{ job.employer.name }}",
                        //should do the nice date upstream in view
                        post_date           : new Date("{{ job.post_date }}").toDateString()

            });

            //Add this point to the bounds, so the map knows its own extent with this new marker
            bounds.extend(new L.LatLng(marker._latlng.lat,marker._latlng.lng));

            //set marker count so we can request more later
            marker_count++;

        {% endfor %}


        //Set the zoom and center point to fit the bounds
        map.locate({'setView' : true, 'timeout' : 10000, maxZoom: 10});

        //if wedon't get a location from the browser, set the
        map.on('locationerror', function () {map.fitBounds(bounds);});


        //add extra control for ajax request of more jobs
        map.addControl(new olderJobs({marker_count : marker_count, oldest_job : oldest_job }) );


    </script>
{% endblock extra_javascript %}
